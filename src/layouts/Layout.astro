---
import { Font } from "astro:assets";
import { ClientRouter } from "astro:transitions";

import "@styles/global.css";

import type { SanityDocument } from "@sanity/client";
import { loadQuery } from "@sanity/lib/load-query";

import Header from "@components/Sections/Header.astro";
import Footer from "@components/Sections/Footer.astro";

const { data: contacts } = await loadQuery<SanityDocument>({
  query: `*[_type == "contacts"][0]{
    phone,
    email,
    facebook,
    instagram,
    viber,
    mobileBG
  }`,
});

const {
  title = "Купете кола от САЩ с xclusiveCars | Внос под ключ от Америка до България",
  description = "xclusiveCars - професионален внос на автомобили от Америка и Канада. Избор, закупуване, транспорт и митническо оформяне. Спестете до 40% от цената. Доставка до вашия дом в България.",
  image = "/opengraph.png",
  noindex,
  nextPage,
  prevPage,
} = Astro.props;

const canonicalURL = new URL(Astro.url.pathname, Astro.site).href;
const ogImageURL = new URL(image, Astro.site).href;

const prevURL = prevPage ? new URL(prevPage, Astro.site).href : null;
const nextURL = nextPage ? new URL(nextPage, Astro.site).href : null;

const enableAnalytics = import.meta.env.PUBLIC_ENABLE_ANALYTICS === "true";

const organizationSchema = {
  "@context": "https://schema.org",
  "@type": "AutoDealer",
  name: "xclusiveCars",
  description: "Професионален внос на автомобили от САЩ и Канада до България",
  url: Astro.site?.href,
  logo: new URL("/favicon.webp", Astro.site).href,
  image: new URL("/opengraph.png", Astro.site).href,
  telephone: contacts?.phone?.forLink,
  email: contacts?.email,
  address: {
    "@type": "PostalAddress",
    streetAddress: "Hristo Botev Blvd 117",
    addressLocality: "Sofia",
    addressRegion: "Sofia Center",
    postalCode: "1303",
    addressCountry: "BG",
  },
  areaServed: {
    "@type": "Country",
    name: "Bulgaria",
  },
  sameAs: [
    contacts?.facebook,
    contacts?.instagram,
  ].filter(Boolean),
};

const websiteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  name: "xclusiveCars",
  url: Astro.site?.href,
};
---

<!doctype html>
<html lang="bg">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalURL} />
    {prevURL && <link rel="prev" href={prevURL} />}
    {nextURL && <link rel="next" href={nextURL} />}

    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImageURL} />
    <meta property="og:locale" content="bg_BG" />
    <meta property="og:site_name" content="xclusiveCars" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImageURL} />

    <meta name="theme-color" content="#000000" />
    <link rel="icon" type="image/webp" href="/favicon.webp" />
    <link rel="apple-touch-icon" href="/favicon.webp" />
    <Font cssVariable="--font-jura" preload />
    {noindex && <meta name="robots" content="noindex, follow" />}

    <ClientRouter />

    <script type="application/ld+json" set:html={JSON.stringify(organizationSchema)} />
    <script type="application/ld+json" set:html={JSON.stringify(websiteSchema)} />

    {enableAnalytics && (
      <>
        <link rel="preconnect" href="https://cloud.umami.is" />
        <script
          is:inline
          defer
          src="https://cloud.umami.is/script.js"
          data-website-id="671fc502-97d2-46e3-842c-110fd7d4e4ed"
        />
      </>
    )}
  </head>
  <body>
    <Header contacts={contacts} />
    <slot />
    <Footer contacts={contacts} />
  </body>
</html>
